<%- include('../partials/header') %>

<div class="container" style="padding: 2rem 0;">
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem; color: #667eea;">üëã Welcome back, <%= user.fullName %>!</h1>
        <p style="color: rgba(255, 255, 255, 0.8);">Browse properties and connect with verified agents</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-icon">üè†</span>
            <span class="stat-number"><%= properties.length %></span>
            <span class="stat-label">Available Properties</span>
        </div>

        <div class="stat-card">
            <span class="stat-icon">üë•</span>
            <span class="stat-number"><%= client.unlockedAgents.length %></span>
            <span class="stat-label">Unlocked Agents</span>
        </div>

        <div class="stat-card">
            <span class="stat-icon">üí∞</span>
            <span class="stat-number"><%= client.unlockedAgents.length %></span>
            <span class="stat-label">Contacted Agents</span>
        </div>

        <div class="stat-card">
            <span class="stat-icon">üìä</span>
            <span class="stat-number"><%= properties.filter(p => p.status === 'active').length %></span>
            <span class="stat-label">Active Properties</span>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card mb-4">
        <h2 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: #667eea;">‚ö° Quick Actions</h2>
        <div class="grid grid-4">
            <a href="/houses" class="btn btn-success">üîç Browse All Properties</a>
            <a href="/about" class="btn btn-secondary">‚ÑπÔ∏è About HomLet</a>
            <a href="/contact" class="btn btn-warning">üìû Contact Support</a>
            <a href="/auth/logout" class="btn btn-danger">üö™ Logout</a>
        </div>
    </div>

    <!-- Smart Search Filters -->
    <div class="card mb-4">
        <h2 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: #667eea;">üîç Smart Property Search</h2>
        <form method="GET" action="/client/dashboard" class="smart-search-form">
            <div class="search-grid">
                <div class="form-group">
                    <label class="form-label">State</label>
                    <input type="text" name="state" 
                           value="<%= typeof filters !== 'undefined' && filters.state ? filters.state : '' %>" 
                           placeholder="Lagos, Abuja, Rivers..." 
                           class="smart-search-input"
                           list="states-list">
                    <datalist id="states-list">
                        <option value="Lagos">
                        <option value="Abuja">
                        <option value="Rivers">
                        <option value="Ogun">
                        <option value="Kano">
                        <option value="Kaduna">
                        <option value="Oyo">
                        <option value="Delta">
                        <option value="Edo">
                        <option value="Anambra">
                    </datalist>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Area</label>
                    <input type="text" name="area" 
                           value="<%= typeof filters !== 'undefined' && filters.area ? filters.area : '' %>" 
                           placeholder="Victoria Island, Lekki, Ikeja..." 
                           class="smart-search-input"
                           list="areas-list">
                    <datalist id="areas-list">
                        <option value="Victoria Island">
                        <option value="Lekki">
                        <option value="Ikeja">
                        <option value="Ikoyi">
                        <option value="Surulere">
                        <option value="Yaba">
                        <option value="Gbagada">
                        <option value="Ajah">
                        <option value="Magodo">
                        <option value="Alimosho">
                        <option value="Igando">
                        <option value="Egbeda">
                        <option value="Isolo">
                        <option value="Oshodi">
                        <option value="Maryland">
                    </datalist>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Min Price (‚Ç¶)</label>
                    <input type="number" name="minPrice" 
                           value="<%= typeof filters !== 'undefined' && filters.minPrice ? filters.minPrice : '' %>" 
                           placeholder="100,000" 
                           class="smart-search-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Max Price (‚Ç¶)</label>
                    <input type="number" name="maxPrice" 
                           value="<%= typeof filters !== 'undefined' && filters.maxPrice ? filters.maxPrice : '' %>" 
                           placeholder="5,000,000" 
                           class="smart-search-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Property Type</label>
                    <select name="type" class="smart-search-input">
                        <option value="">All Types</option>
                        <option value="rent" <%= typeof filters !== 'undefined' && filters.type === 'rent' ? 'selected' : '' %>>For Rent</option>
                        <option value="buy" <%= typeof filters !== 'undefined' && filters.type === 'buy' ? 'selected' : '' %>>For Sale</option>
                    </select>
                </div>
            </div>
            
            <div class="search-actions">
                <button type="submit" class="btn btn-primary">üîç Search Properties</button>
                <a href="/client/dashboard" class="btn btn-secondary">üîÑ Clear Filters</a>
            </div>
        </form>
    </div>

    <!-- Properties Grid -->
    <div style="margin-bottom: 2rem;">
        <h2 style="font-size: 1.8rem; margin-bottom: 1.5rem; color: #667eea;">üè† Available Properties</h2>
        
        <div class="grid grid-3">
            <% if (typeof properties !== 'undefined' && properties && properties.length > 0) { %>
                <% properties.forEach(property => { %>
                    <div class="property-card">
                        <div class="property-image-container">
                            <img src="/uploads/properties/<%= property.images[0] %>" alt="<%= property.title %>">
                            <div class="property-badge">
                                <%= property.propertyType === 'rent' ? 'For Rent' : 'For Sale' %>
                            </div>
                            <div class="property-views">
                                üëÅÔ∏è <%= property.views %> views
                            </div>
                        </div>
                        
                        <div class="property-card-content">
                            <h3 class="property-title"><%= property.title %></h3>
                            <p class="property-location">üìç <%= property.location.area %>, <%= property.location.state %></p>
                            <p class="property-price">‚Ç¶<%= property.price.toLocaleString() %></p>
                            <p class="property-description"><%= property.description.substring(0, 100) %>...</p>
                            
                            <div class="property-meta">
                                <div class="property-agent">
                                    <span>Agent: <%= property.agent.fullName %></span>
                                </div>
                                <div class="property-date">
                                    <%= new Date(property.createdAt).toLocaleDateString() %>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                                <a href="/property/<%= property._id %>" class="btn btn-primary" style="flex: 1;">View Details</a>
                                
                                <% if (client.unlockedAgents.some(agent => agent._id.toString() === property.agent._id.toString())) { %>
                                    <div style="text-align: center;">
                                        <div style="background: rgba(81, 207, 102, 0.2); color: #51cf66; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; margin-bottom: 0.5rem;">
                                            ‚úÖ Unlocked
                                        </div>
                                        <div style="font-weight: 600; color: #51cf66; font-size: 0.9rem;">
                                            üìû <%= property.agent.phone %>
                                        </div>
                                        <a href="/client/rate/<%= property.agent._id %>" class="btn btn-warning btn-sm" style="margin-top: 0.5rem;">Rate Agent</a>
                                    </div>
                                <% } else { %>
                                    <button onclick="contactAgent('<%= property.agent._id %>', '<%= property._id %>')" class="btn btn-success contact-btn" style="white-space: nowrap;">
                                        üìû Contact Agent
                                    </button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div style="grid-column: 1 / -1; text-align: center; padding: 4rem 0;">
                    <div style="color: rgba(255, 255, 255, 0.7);">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üè†</div>
                        <p style="font-size: 1.5rem; margin-bottom: 1rem;">No properties found matching your criteria</p>
                        <p>Try adjusting your search filters or <a href="/client/dashboard" style="color: #667eea;">browse all properties</a></p>
                    </div>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Unlocked Agents Section -->
    <% if (client.unlockedAgents && client.unlockedAgents.length > 0) { %>
        <div class="card">
            <h2 style="font-size: 1.5rem; margin-bottom: 1.5rem; color: #667eea;">üë• Your Unlocked Agents</h2>
            <div class="grid grid-3">
                <% client.unlockedAgents.forEach(agent => { %>
                    <div style="background: rgba(30, 30, 30, 0.8); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.05);">
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #51cf66, #40c057); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-weight: bold; font-size: 1.5rem;">
                            <%= agent.fullName.charAt(0) %>
                        </div>
                        <h4 style="color: #ffffff; margin-bottom: 0.5rem;"><%= agent.fullName %></h4>
                        <p style="color: #51cf66; font-weight: 600; margin-bottom: 1rem;">üìû <%= agent.phone %></p>
                        <a href="/client/rate/<%= agent._id %>" class="btn btn-warning btn-sm">Rate Agent</a>
                    </div>
                <% }); %>
            </div>
        </div>
    <% } %>
</div>

<script>
// Contact agent function
function contactAgent(agentId, propertyId) {
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="loading-spinner"></span> Contacting...';
    button.disabled = true;
    
    // Send contact notification to backend
    fetch('/client/contact-agent', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            agentId: agentId,
            propertyId: propertyId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessNotification('‚úÖ Contact request sent! The agent has been notified and will reach out to you soon.');
        } else {
            showErrorNotification('‚ùå Error: ' + (data.error || 'Failed to send contact request'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorNotification('‚ùå Failed to send contact request. Please try again.');
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function showSuccessNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification success';
    notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon">‚úÖ</div>
            <div class="notification-message">${message}</div>
        </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function showErrorNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification error';
    notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon">‚ùå</div>
            <div class="notification-message">${message}</div>
        </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Smart search with fuzzy matching
document.querySelectorAll('.smart-search-input').forEach(input => {
    input.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        const datalist = document.querySelector(`#${this.getAttribute('list')}`);
        
        if (datalist) {
            const options = datalist.querySelectorAll('option');
            options.forEach(option => {
                const optionValue = option.value.toLowerCase();
                if (optionValue.includes(value) || value.includes(optionValue.substring(0, 3))) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }
    });
});
</script>

<style>
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    max-width: 400px;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease-out;
}

.notification.success {
    background: rgba(81, 207, 102, 0.9);
    border: 1px solid #51cf66;
}

.notification.error {
    background: rgba(255, 107, 107, 0.9);
    border: 1px solid #ff6b6b;
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.notification-icon {
    font-size: 1.5rem;
}

.notification-message {
    color: white;
    font-weight: 500;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<%- include('../partials/footer') %>
            button.innerHTML = originalText;
            button.disabled = false;
        }
    });
    
    handler.openIframe();
});

function showSuccessNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification success';
    notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon">‚úÖ</div>
            <div class="notification-message">${message}</div>
        </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function showErrorNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification error';
    notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon">‚ùå</div>
            <div class="notification-message">${message}</div>
        </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Smart search with fuzzy matching
document.querySelectorAll('.smart-search-input').forEach(input => {
    input.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        const datalist = document.querySelector(`#${this.getAttribute('list')}`);
        
        if (datalist) {
            const options = datalist.querySelectorAll('option');
            options.forEach(option => {
                const optionValue = option.value.toLowerCase();
                if (optionValue.includes(value) || value.includes(optionValue.substring(0, 3))) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }
    });
});
</script>

<%- include('../partials/footer') %>